#!/usr/bin/env bash
#
# AXIS Language CLI
# Version: 1.1.0 - Dual Mode (Script + Compile)
#

# This will be updated by install.sh
AXIS_LIB_DIR="$HOME/.local/lib/axis"

# Find Python 3
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    echo "Error: Python 3 not found" >&2
    exit 1
fi

# Check if library directory exists
if [ ! -d "$AXIS_LIB_DIR" ]; then
    echo "Error: AXIS library not found at $AXIS_LIB_DIR" >&2
    echo "Please reinstall AXIS" >&2
    exit 1
fi

# Version information
VERSION="1.1.0"

# Show help
show_help() {
    cat << EOF
AXIS Language ($VERSION) - Dual Mode: Script & Compile

Usage:
    axis <file.axis>                     Auto-detect mode and run/compile
    axis run <file.axis>                 Force interpret (script mode)
    axis build <file.axis> [options]     Force compile (compile mode)
    axis --version                       Show version information
    axis --help                          Show this help message

Mode Detection:
    If file starts with 'mode script'  → Interpreted (cross-platform)
    If file starts with 'mode compile' → Compiled to ELF64 (Linux only)
    Default (no mode declaration)      → Compile mode

Build Options:
    -o, --output <file>                  Output file name (default: same as input)
    -v, --verbose                        Show assembly output
    --no-hex                             Don't show hex dump

Examples:
    axis script.axis                     # Runs if 'mode script', compiles otherwise
    axis run program.axis                # Force run as script
    axis build program.axis              # Compile to ./program
    axis build program.axis -o myapp     # Compile to ./myapp

For more information: https://github.com/AGDNoob/axis-lang
EOF
}

# Show version
show_version() {
    cat << EOF
AXIS Language
Version: $VERSION
Modes: script (interpreted), compile (native ELF64)
Platform: Linux x86-64 (compile), Any (script)
Python: $($PYTHON_CMD --version 2>&1)

Compiler location: $AXIS_LIB_DIR
EOF
}

# Detect mode from file
detect_mode() {
    local file="$1"
    # Read first non-empty, non-comment line
    local first_line=$(grep -m1 -E "^[^#]" "$file" 2>/dev/null | head -1)
    
    if [[ "$first_line" =~ ^[[:space:]]*mode[[:space:]]+script ]]; then
        echo "script"
    elif [[ "$first_line" =~ ^[[:space:]]*mode[[:space:]]+compile ]]; then
        echo "compile"
    else
        echo "compile"  # Default
    fi
}

# Run script (interpreted)
cmd_run_script() {
    local input_file="$1"
    
    cd "$AXIS_LIB_DIR"
    exec $PYTHON_CMD compilation_pipeline.py run "$input_file"
}

# Build (compile to ELF)
cmd_build() {
    local input_file="$1"
    shift
    
    # Parse options
    local output_file=""
    local verbose=""
    local no_hex="--no-hex"
    
    while [ $# -gt 0 ]; do
        case "$1" in
            -o|--output)
                output_file="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="-v"
                no_hex=""
                shift
                ;;
            --no-hex)
                no_hex="--no-hex"
                shift
                ;;
            *)
                echo "Error: Unknown option: $1" >&2
                exit 1
                ;;
        esac
    done
    
    # Default output: same name without .axis, in same directory as source
    if [ -z "$output_file" ]; then
        local dir=$(dirname "$input_file")
        local base=$(basename "$input_file" .axis)
        output_file="$dir/$base"
    fi
    
    # Run compiler
    cd "$AXIS_LIB_DIR"
    $PYTHON_CMD compilation_pipeline.py build "$input_file" -o "$output_file" --elf $verbose $no_hex
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "Executable created: $output_file"
        echo "Run with: chmod +x $output_file && $output_file"
    fi
}

# Auto command - detect mode and act
cmd_auto() {
    local input_file="$1"
    shift
    
    if [ ! -f "$input_file" ]; then
        echo "Error: File not found: $input_file" >&2
        exit 1
    fi
    
    # Check if .axis extension
    if [[ "$input_file" != *.axis ]]; then
        echo "Warning: File does not have .axis extension" >&2
    fi
    
    local mode=$(detect_mode "$input_file")
    
    if [ "$mode" = "script" ]; then
        cmd_run_script "$input_file"
    else
        cmd_build "$input_file" "$@"
    fi
}

# Validate input file exists
check_input_file() {
    if [ -z "$1" ]; then
        echo "Error: No input file specified" >&2
        echo "Usage: axis <file.axis>" >&2
        exit 1
    fi
    
    if [ ! -f "$1" ]; then
        echo "Error: File not found: $1" >&2
        exit 1
    fi
}

# Main dispatcher
case "$1" in
    build)
        shift
        check_input_file "$1"
        cmd_build "$@"
        ;;
    run)
        shift
        check_input_file "$1"
        cmd_run_script "$1"
        ;;
    --version|-V)
        show_version
        ;;
    --help|-h|help)
        show_help
        ;;
    "")
        echo "Error: No command specified" >&2
        echo "Run 'axis --help' for usage information" >&2
        exit 1
        ;;
    -*)
        echo "Error: Unknown option: $1" >&2
        echo "Run 'axis --help' for usage information" >&2
        exit 1
        ;;
    *)
        # Auto mode - file specified directly
        check_input_file "$1"
        cmd_auto "$@"
        ;;
esac
